name: 'Build and Promote Release'

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ github.ref_name }} # Pass the tag to other jobs
    steps:
      # ... steps to build and push the Docker image tagged with github.ref_name ...
      - name: Build and Push to ECR
        run: |
          echo "Building and pushing image with tag ${{ github.ref_name }}"
          # Your docker build/push commands here

  deploy-test:
    needs: build
    runs-on: ubuntu-latest
    environment: test
    steps:
      - name: Trigger Test Deployment Workflow ðŸš€
        uses: benc-uk/workflow-dispatch@v1
        with:
          # The filename of the workflow you want to trigger
          workflow: 'inputs-wf.yml'
          # Use the PAT you created
          token: ${{ secrets.ACTION_PAT }}
          # Pass the inputs required by that workflow
          inputs: '{ "version": "${{ needs.build.outputs.image_tag }}", "stack_name": "test" }'


  deploy-nonprod:
    needs: deploy-test # This job only starts after deploy-test succeeds
    runs-on: ubuntu-latest
    environment: nonprod # Requires approval if configured
    steps:
      - name: Deploy to Non-Prod EKS
        run: |
          echo "Deploying tag ${{ needs.build.outputs.image_tag }} to Non-Prod"
          # Your helm or kubectl commands here

  deploy-production:
    needs: deploy-nonprod # This job only starts after deploy-nonprod succeeds
    runs-on: ubuntu-latest
    environment: production # Requires approval if configured
    steps:
      - name: Deploy to Production EKS
        run: |
          echo "Deploying tag ${{ needs.build.outputs.image_tag }} to Production"
          # Your helm or kubectl commands here